{% extends 'base_sidebar.html' %}
{% load static %}

{% block title %}Reporte Plataformas{% endblock %}
{% block page_title %}Reporte de Fallas de Plataforma{% endblock %}
{% block page_subtitle %}Sistema de registro de caídas INNOVEX, SINPLANT e IDEAL CONTROL{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/formulario.css' %}">
<style>
    .form-container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); max-width: 900px; }
    .form-container h1 { display: none; }
    .form-logo { max-height: 60px; }
    .page-layout, .sidebar-actions { display: none !important; }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border-left: 4px solid #17a2b8;
    }
    .form-section h2 {
        color: #1e3a5f;
        font-size: 1.2em;
        margin: 0 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }
    .form-group {
        margin-bottom: 18px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 0.95em;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.3s;
        box-sizing: border-box;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: #17a2b8;
        outline: none;
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.15);
    }
    .form-group input[type="radio"] {
        width: auto;
        margin-right: 8px;
    }
    #submitForm {
        width: 100%;
        padding: 15px 30px;
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
    }
    #submitForm:hover {
        box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        transform: translateY(-2px);
    }
    .form-section-visible { display: block; }
</style>
{% endblock %}

{% block header_actions %}
<a href="{% url 'consulta_plataformas' %}" class="header-btn">
    <i class="fas fa-list"></i> Ver Reportes
</a>
{% endblock %}

{% block content %}
<div class="form-container">
    <div style="text-align: right; margin-bottom: 20px;">
        <img src="{% static 'imagenes/logo-reporte-cermaq.png' %}" alt="Logo" class="form-logo">
    </div>

    <form id="plataformaForm">
        {% csrf_token %}
        
        <section class="form-section form-section-visible">
            <h2>1. Información Básica del Reporte</h2>
            <div class="form-group">
                <label for="fechaHora">Fecha y Hora de la Caída:</label>
                <input type="datetime-local" id="fechaHora" name="fechaHora" required>
            </div>
            <div class="form-group">
                <label for="turno">Turno:</label>
                <select id="turno" name="turno" required>
                    <option value="">Seleccione un turno</option>
                    <option value="Mañana">Mañana</option>
                    <option value="Tarde">Tarde</option>
                    <option value="Noche">Noche</option>
                </select>
            </div>
            <div class="form-group">
                <label for="plataforma">Plataforma Afectada:</label>
                <select id="plataforma" name="plataforma" required>
                    <option value="">Seleccione la plataforma</option>
                    <option value="INNOVEX">INNOVEX (Liquiñe / Trafún)</option>
                    <option value="SINPLANT">SINPLANT (Cipreses)</option>
                    <option value="IDEAL CONTROL">IDEAL CONTROL (Todos los centros)</option>
                </select>
            </div>
            <div class="form-group" id="centroIdealControlGroup" style="display: none;">
                <label for="centroIdealControl">Centro Afectado:</label>
                <select id="centroIdealControl" name="centroIdealControl">
                    <option value="">Seleccione el centro afectado</option>
                    <option value="trafun">Trafún</option>
                    <option value="cipreses">Cipreses</option>
                    <option value="liquine">Liquiñe</option>
                    <option value="rahue">Rahue</option>
                    <option value="santa-juana">Santa Juana</option>
                    <option value="pcc">PCC</option>
                    <option value="esperanza">Esperanza</option>
                    <option value="hueyusca">Hueyusca</option>
                </select>
            </div>
            <input type="hidden" id="centro" name="centro">
        </section>

        <section class="form-section form-section-visible">
            <h2>2. Detalles de la Falla</h2>
            <div class="form-group">
                <label for="sistemaFallando">Tipo de Falla:</label>
                <select id="sistemaFallando" name="sistemaFallando" required>
                    <option value="">Seleccione el tipo de falla</option>
                    <option value="Plataforma caída - Sin visualización de datos">Plataforma caída - Sin visualización de datos</option>
                    <option value="Datos sin actualizar - Sin carga en tiempo real">Datos sin actualizar - Sin carga en tiempo real</option>
                    <option value="Sistema congelado - Interfaz no responde">Sistema congelado - Interfaz no responde</option>
                    <option value="Otro">Otro (especificar en observaciones)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tiempoFueraServicio">Tiempo Fuera de Servicio:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="tiempoFueraServicio" name="tiempoFueraServicio" min="0" placeholder="Duración" required style="flex: 2;">
                    <select id="unidadTiempo" name="unidadTiempo" required style="flex: 1;">
                        <option value="minutos">Minutos</option>
                        <option value="dias">Días</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>¿Se contactó con el proveedor?</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div><input type="radio" id="contactoProveedorNo" name="contactoProveedor" value="no" required><label for="contactoProveedorNo">No se contactó</label></div>
                    <div><input type="radio" id="contactoProveedorSi" name="contactoProveedor" value="si" required><label for="contactoProveedorSi">Sí, con respuesta</label></div>
                    <div><input type="radio" id="contactoProveedorSinRespuesta" name="contactoProveedor" value="sin_respuesta" required><label for="contactoProveedorSinRespuesta">Sí, sin respuesta</label></div>
                </div>
            </div>
            <div class="form-group">
                <label for="razonCaida">Razón de la Caída:</label>
                <select id="razonCaida" name="razonCaida" required>
                    <option value="">Seleccione la razón de la caída</option>
                    <option value="Sin respuesta del proveedor">Sin respuesta del proveedor</option>
                    <option value="Plataforma caída - Sin visualización de datos">Plataforma caída - Sin visualización de datos</option>
                    <option value="Datos sin actualizar - Sin carga en tiempo real">Datos sin actualizar - Sin carga en tiempo real</option>
                    <option value="Sistema congelado - Interfaz no responde">Sistema congelado - Interfaz no responde</option>
                    <option value="Pérdida de conectividad">Pérdida de conectividad</option>
                    <option value="Cambio de servidor / Interferencia técnica">Cambio de servidor / Interferencia técnica</option>
                    <option value="Actualización / Modificación del sistema">Actualización / Modificación del sistema</option>
                    <option value="Mantenimiento programado">Mantenimiento programado</option>
                    <option value="Falla eléctrica">Falla eléctrica</option>
                    <option value="Sobrecarga del sistema">Sobrecarga del sistema</option>
                    <option value="Error de software">Error de software</option>
                    <option value="Otro">Otro (especificar en observaciones)</option>
                </select>
            </div>
        </section>

        <section class="form-section form-section-visible">
            <h2>3. Evaluación de Impacto</h2>
            <div class="form-group">
                <label>Riesgo para Peces:</label>
                <input type="radio" id="riesgoPecesSi" name="riesgoPeces" value="si" required><label for="riesgoPecesSi">Sí</label>
                <input type="radio" id="riesgoPecesNo" name="riesgoPeces" value="no" required><label for="riesgoPecesNo">No</label>
            </div>
            <div class="form-group">
                <label>Pérdida Económica:</label>
                <input type="radio" id="perdidaEconomicaSi" name="perdidaEconomica" value="si" required><label for="perdidaEconomicaSi">Sí</label>
                <input type="radio" id="perdidaEconomicaNo" name="perdidaEconomica" value="no" required><label for="perdidaEconomicaNo">No</label>
            </div>
            <div class="form-group">
                <label for="responsable">Responsable del Reporte:</label>
                <input type="text" id="responsable" name="responsable" placeholder="Nombre del responsable" required>
            </div>
            <div class="form-group">
                <label for="observacion">Observaciones Adicionales:</label>
                <textarea id="observacion" name="observacion" rows="3" placeholder="Cualquier información adicional relevante..."></textarea>
            </div>
        </section>

        <button type="button" id="submitForm">Registrar Reporte de Plataforma</button>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Datos del reporte a editar (si existe)
const reporteEditar = {{ reporte_editar|safe|default:"null" }};
const editando = {{ editando|default:"false"|lower }};

// Auto-llenar fecha y hora actual solo si no estamos editando
const fechaHoraInput = document.getElementById('fechaHora');
if (fechaHoraInput && !fechaHoraInput.value && !editando) {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const localTime = new Date(now.getTime() - offset);
    fechaHoraInput.value = localTime.toISOString().slice(0, 16);
}

// Cargar datos si estamos editando
if (editando && reporteEditar) {
    document.getElementById('fechaHora').value = reporteEditar.fecha_hora;
    document.getElementById('turno').value = reporteEditar.turno;
    document.getElementById('plataforma').value = reporteEditar.plataforma;
    document.getElementById('sistemaFallando').value = reporteEditar.sistema_fallando;
    document.getElementById('tiempoFueraServicio').value = reporteEditar.tiempo_fuera_servicio;
    document.getElementById('unidadTiempo').value = reporteEditar.unidad_tiempo;
    document.getElementById('razonCaida').value = reporteEditar.razon_caida;
    document.getElementById('responsable').value = reporteEditar.responsable;
    document.getElementById('observacion').value = reporteEditar.observacion;
    
    // Seleccionar radio buttons
    document.querySelector(`input[name="contactoProveedor"][value="${reporteEditar.contacto_proveedor}"]`).checked = true;
    document.querySelector(`input[name="riesgoPeces"][value="${reporteEditar.riesgo_peces ? 'si' : 'no'}"]`).checked = true;
    document.querySelector(`input[name="perdidaEconomica"][value="${reporteEditar.perdida_economica ? 'si' : 'no'}"]`).checked = true;
    
    // Actualizar texto del botón
    document.getElementById('submitForm').textContent = 'Actualizar Reporte de Plataforma';
    
    // Trigger cambio de plataforma para mostrar/ocultar campos
    document.getElementById('plataforma').dispatchEvent(new Event('change'));
    
    // Si es IDEAL CONTROL, seleccionar el centro
    if (reporteEditar.plataforma === 'IDEAL CONTROL') {
        setTimeout(() => {
            document.getElementById('centroIdealControl').value = reporteEditar.centro_id;
            document.getElementById('centro').value = reporteEditar.centro_id;
        }, 100);
    } else {
        document.getElementById('centro').value = reporteEditar.centro_id;
    }
}

const centros = { {% for c in centros %}'{{ c.nombre }}': '{{ c.id }}',{% endfor %} };

const centroIdealControlGroup = document.getElementById('centroIdealControlGroup');
const centroIdealControlSelect = document.getElementById('centroIdealControl');

document.getElementById('plataforma').addEventListener('change', function() {
    const plataforma = this.value;
    const centroInput = document.getElementById('centro');
    
    if (plataforma === 'INNOVEX') {
        centroIdealControlGroup.style.display = 'none';
        centroIdealControlSelect.removeAttribute('required');
        centroInput.value = centros['Liquiñe'] || centros['Trafun'] || centros['Trafún'] || '';
    } else if (plataforma === 'SINPLANT') {
        centroIdealControlGroup.style.display = 'none';
        centroIdealControlSelect.removeAttribute('required');
        centroInput.value = centros['Cipreses'] || '';
    } else if (plataforma === 'IDEAL CONTROL') {
        centroIdealControlGroup.style.display = 'block';
        centroIdealControlSelect.setAttribute('required', 'required');
        centroInput.value = '';
    } else {
        centroIdealControlGroup.style.display = 'none';
        centroIdealControlSelect.removeAttribute('required');
        centroInput.value = '';
    }
});

centroIdealControlSelect.addEventListener('change', function() {
    const centroInput = document.getElementById('centro');
    const centroSeleccionado = this.value;
    
    if (centroSeleccionado) {
        centroInput.value = centroSeleccionado;
    } else {
        centroInput.value = '';
    }
});

document.getElementById('submitForm').addEventListener('click', function() {
    const form = document.getElementById('plataformaForm');
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    const contactoProveedor = document.querySelector('input[name="contactoProveedor"]:checked')?.value || 'no';
    const riesgoPeces = document.querySelector('input[name="riesgoPeces"]:checked')?.value === 'si';
    const perdidaEconomica = document.querySelector('input[name="perdidaEconomica"]:checked')?.value === 'si';
    
    const data = {
        fecha_hora: document.getElementById('fechaHora').value,
        turno: document.getElementById('turno').value,
        centro: document.getElementById('centro').value,
        plataforma: document.getElementById('plataforma').value,
        sistema_fallando: document.getElementById('sistemaFallando').value,
        tiempo_fuera_servicio: document.getElementById('tiempoFueraServicio').value,
        unidad_tiempo: document.getElementById('unidadTiempo').value,
        contacto_proveedor: contactoProveedor,
        razon_caida: document.getElementById('razonCaida').value,
        riesgo_peces: riesgoPeces,
        perdida_economica: perdidaEconomica,
        responsable: document.getElementById('responsable').value,
        observacion: document.getElementById('observacion').value
    };
    
    // Si estamos editando, agregar el ID del reporte
    if (editando && reporteEditar) {
        data.id = reporteEditar.id;
    }
    
    if (!data.centro) { alert('Error: No se pudo determinar el centro.'); return; }
    
    this.disabled = true;
    this.textContent = 'Guardando...';
    
    fetch('/api/plataformas/guardar/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('¡Reporte registrado con éxito!');
            form.reset();
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
            this.disabled = false;
            this.textContent = 'Registrar Reporte de Plataforma';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el reporte');
        this.disabled = false;
        this.textContent = 'Registrar Reporte de Plataforma';
    });
});
</script>
{% endblock %}
