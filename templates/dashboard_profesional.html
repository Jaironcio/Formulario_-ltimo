<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard Profesional - Incidencias PCC</title>
    {% load static %}
    {% load humanize %}
    <link rel="stylesheet" href="{% static 'css/dashboard_profesional.css' %}?v=20260130-2008">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8"></script>
    <style>
        .charts-grid-extended {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-full-width {
            grid-column: 1 / -1;
        }
        #mapa-google {
            width: 100%;
            height: 400px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <img src="{% static 'imagenes/logo-reporte-cermaq.png' %}" alt="CERMAQ" class="logo">
                <h1>Dashboard Profesional - <span id="centro-actual">Todos los Centros</span> - <span id="periodo-actual">Todos los meses</span></h1>
            </div>
            <div class="header-right">
                <button onclick="window.location.href='{% url 'dashboard' %}'" class="btn-back">‚Üê Dashboard Principal</button>
                <button onclick="exportarExcel()" class="btn-export">üìä Exportar Excel</button>
            </div>
        </header>

        <div class="dashboard-content">
            <!-- Panel de Filtros -->
            <aside class="filters-panel">
                <h3>Filtros</h3>
                
                <div class="filter-group">
                    <label>Centro</label>
                    <div class="filter-options">
                        <label><input type="checkbox" id="todos-centros" checked onchange="toggleTodosCentros()"> Todos</label>
                        {% for centro in centros %}
                        <label><input type="checkbox" class="filter-centro" value="{{ centro.nombre }}" checked onchange="filtrarDatos()"> {{ centro.nombre }}</label>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-group">
                    <label>Mes</label>
                    <select id="filtro-mes" onchange="filtrarDatos()" class="filter-select">
                        <option value="todos">Todos los meses</option>
                        {% for mes in meses_unicos %}
                        <option value="{{ mes.numero }}">{{ mes.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Tipo Incidencia</label>
                    <div class="filter-options scrollable">
                        <label><input type="checkbox" id="todos-tipos" checked onchange="toggleTodosTipos()"> Todos</label>
                        <label><input type="checkbox" class="filter-tipo" value="Ox√≠geno Alto" checked onchange="filtrarDatos()"> Ox√≠geno Alto</label>
                        <label><input type="checkbox" class="filter-tipo" value="Ox√≠geno Bajo" checked onchange="filtrarDatos()"> Ox√≠geno Bajo</label>
                        <label><input type="checkbox" class="filter-tipo" value="Temperatura Baja" checked onchange="filtrarDatos()"> Temperatura Baja</label>
                    </div>
                </div>

                <button onclick="resetearFiltros()" class="btn-reset">üîÑ Resetear Filtros</button>
            </aside>

            <!-- Contenido Principal -->
            <main class="main-content">
                <!-- KPIs -->
                <section class="kpis-section">
                    <div class="kpi-card kpi-primary">
                        <div class="kpi-value" id="kpi-total">{{ total_incidencias }}</div>
                        <div class="kpi-label">Total Incidencias</div>
                    </div>
                    <div class="kpi-card kpi-success">
                        <div class="kpi-value" id="kpi-oxigeno-alto">{{ oxigeno_alto }}</div>
                        <div class="kpi-label">Ox√≠geno Alto</div>
                    </div>
                    <div class="kpi-card kpi-warning">
                        <div class="kpi-value" id="kpi-oxigeno-bajo">{{ oxigeno_bajo }}</div>
                        <div class="kpi-label">Ox√≠geno Bajo</div>
                    </div>
                    <div class="kpi-card kpi-danger">
                        <div class="kpi-value" id="kpi-temperatura-baja">{{ temperatura_baja }}</div>
                        <div class="kpi-label">Temperatura Baja</div>
                    </div>
                    <div class="kpi-card kpi-info">
                        <div class="kpi-value-small" id="kpi-centro-top">{{ centro_top }}</div>
                        <div class="kpi-label">Centro m√°s Incidencias</div>
                    </div>
                </section>

                <!-- Gr√°ficos Principales -->
                <section class="charts-section">
                    <div class="chart-container">
                        <h3>Incidencias por Par√°metro y Centro</h3>
                        <canvas id="chartBarras"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Distribuci√≥n por Tipo</h3>
                        <canvas id="chartDona"></canvas>
                    </div>
                </section>

                <!-- Gr√°ficos Adicionales -->
                <section class="charts-grid-extended">
                    <div class="chart-container chart-full-width">
                        <h3>üìà Tendencia Temporal de Incidencias</h3>
                        <canvas id="chartTendencia"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>‚è±Ô∏è Tiempo Promedio de Resoluci√≥n por Centro</h3>
                        <canvas id="chartResolucion"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üåô Incidencias por Turno</h3>
                        <canvas id="chartTurnos"></canvas>
                    </div>
                </section>

                <!-- Mapa Real con Google Maps -->
                <section class="map-section">
                    <h3>üìç Ubicaci√≥n de Centros PCC</h3>
                    <div id="mapa-google"></div>
                </section>

                <!-- === SECCI√ìN DE AN√ÅLISIS Y JUSTIFICACI√ìN === -->
                <section style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">üìä An√°lisis de Valor y Justificaci√≥n</h2>
                    
                    <!-- Insights Autom√°ticos (Lo que significan los datos) -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; color: white;">
                        <h3 style="margin: 0 0 20px 0; font-size: 24px;">üí° ¬øQu√© nos dicen los datos? (En palabras simples)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            {% for insight in insights %}
                            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 15px; border-radius: 8px; border-left: 4px solid {% if insight.tipo == 'success' %}#27ae60{% elif insight.tipo == 'warning' %}#f39c12{% else %}#3498db{% endif %};">
                                <div style="font-size: 32px; margin-bottom: 10px;">{{ insight.icono }}</div>
                                <h4 style="margin: 0 0 8px 0; font-size: 16px;">{{ insight.titulo }}</h4>
                                <p style="margin: 0; font-size: 14px; opacity: 0.95;">{{ insight.mensaje }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- KPIs de Valor Agregado (M√°s Completos) -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #27ae60;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <h4 style="color: #27ae60; margin: 0; font-size: 14px;">üìâ Reducci√≥n</h4>
                                <span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">{% if reduccion_porcentual > 0 %}‚Üì{% else %}‚Üë{% endif %}</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #27ae60; margin-bottom: 5px;">{{ reduccion_porcentual }}%</div>
                            <p style="color: #7f8c8d; margin: 0; font-size: 13px;">{{ incidencias_evitadas }} incidencias evitadas</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #3498db;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <h4 style="color: #3498db; margin: 0; font-size: 14px;">‚ö° Velocidad</h4>
                                <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">{% if mejora_tiempo_porcentual > 0 %}‚Üì{% else %}‚Üë{% endif %}</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #3498db; margin-bottom: 5px;">{{ mejora_tiempo_porcentual }}%</div>
                            <p style="color: #7f8c8d; margin: 0; font-size: 13px;">{{ minutos_ahorrados }} minutos ahorrados</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #9b59b6;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <h4 style="color: #9b59b6; margin: 0; font-size: 14px;">üéØ Tasa de √âxito</h4>
                                <span style="background: {% if tasa_exito >= 90 %}#27ae60{% elif tasa_exito >= 70 %}#f39c12{% else %}#e74c3c{% endif %}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">{% if tasa_exito >= 90 %}‚úì{% elif tasa_exito >= 70 %}~{% else %}‚úó{% endif %}</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #9b59b6; margin-bottom: 5px;">{{ tasa_exito }}%</div>
                            <p style="color: #7f8c8d; margin: 0; font-size: 13px;">Resueltas en menos de 30 min</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #e67e22;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <h4 style="color: #e67e22; margin: 0; font-size: 14px;">‚öôÔ∏è Eficiencia</h4>
                                <span style="background: #e67e22; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">üìä</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #e67e22; margin-bottom: 5px;">{{ eficiencia_operativa }}</div>
                            <p style="color: #7f8c8d; margin: 0; font-size: 13px;">Incidencias por hora</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #16a085;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <h4 style="color: #16a085; margin: 0; font-size: 14px;">üìç Cobertura</h4>
                                <span style="background: #16a085; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">‚úì</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #16a085; margin-bottom: 5px;">{{ cobertura_centros }}%</div>
                            <p style="color: #7f8c8d; margin: 0; font-size: 13px;">{{ centros_activos }} centros monitoreados</p>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #e74c3c;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <h4 style="color: #e74c3c; margin: 0; font-size: 14px;">üîÑ Recurrencia</h4>
                                <span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">!</span>
                            </div>
                            <div style="font-size: 36px; font-weight: bold; color: #e74c3c; margin-bottom: 5px;">{{ incidencias_recurrentes }}</div>
                            <p style="color: #7f8c8d; margin: 0; font-size: 13px;">vs {{ incidencias_nuevas }} nuevas</p>
                        </div>
                    </div>

                    <!-- Gr√°ficos de An√°lisis -->
                    <div class="charts-grid-extended">
                        <!-- An√°lisis de Causa Ra√≠z -->
                        <div class="chart-container">
                            <h3>üîç Top 5 Causas Ra√≠z de Incidencias</h3>
                            <canvas id="chartCausasRaiz"></canvas>
                            <div style="background: #ecf0f1; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                <p style="color: #2c3e50; margin: 0; font-size: 13px; line-height: 1.6;">
                                    <strong>üí¨ En palabras simples:</strong> Este gr√°fico muestra cu√°les son los problemas m√°s frecuentes. 
                                    Si vemos que "Estanques en Tratamiento" aparece mucho, significa que debemos revisar ese proceso espec√≠fico.
                                </p>
                            </div>
                        </div>

                        <!-- Cumplimiento SLA -->
                        <div class="chart-container">
                            <h3>üéØ ¬øQu√© tan r√°pido respondemos? (Meta: {{ tiempo_objetivo }} minutos)</h3>
                            <canvas id="chartSLA"></canvas>
                            <div style="background: #ecf0f1; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                <p style="color: #2c3e50; margin: 0; font-size: 13px; line-height: 1.6;">
                                    <strong>üí¨ En palabras simples:</strong> Verde = Respondemos r√°pido ‚úì | Rojo = Necesitamos mejorar ‚úó
                                    <br>El % muestra cu√°ntas veces logramos responder en menos de 30 minutos.
                                </p>
                            </div>
                        </div>

                        <!-- Tendencia de Mejora -->
                        <div class="chart-container chart-full-width">
                            <h3>üìà ¬øEstamos mejorando con el tiempo?</h3>
                            <canvas id="chartMejora"></canvas>
                            <div style="background: #ecf0f1; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                <p style="color: #2c3e50; margin: 0; font-size: 13px; line-height: 1.6;">
                                    <strong>üí¨ En palabras simples:</strong> 
                                    L√≠nea Roja bajando = Menos incidencias (¬°Bien!) üìâ | 
                                    L√≠nea Azul bajando = Respondemos m√°s r√°pido (¬°Excelente!) ‚ö°
                                </p>
                            </div>
                        </div>

                        <!-- An√°lisis de Recurrencia -->
                        <div class="chart-container">
                            <h3>üîÑ ¬øSon problemas nuevos o se repiten?</h3>
                            <canvas id="chartRecurrencia"></canvas>
                            <div style="background: #ecf0f1; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                <p style="color: #2c3e50; margin: 0; font-size: 13px; line-height: 1.6;">
                                    <strong>üí¨ En palabras simples:</strong> 
                                    Rojo = Problemas que ya hab√≠amos visto antes (necesitan soluci√≥n permanente) | 
                                    Verde = Problemas nuevos (normales en la operaci√≥n)
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Recomendaciones Accionables -->
                    <div style="margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">üí° Recomendaciones Basadas en Datos</h3>
                        <div style="display: grid; gap: 15px;">
                            {% for rec in recomendaciones %}
                            <div style="background: white; padding: 15px; border-left: 4px solid {% if rec.impacto == 'Alto' %}#e74c3c{% elif rec.impacto == 'Medio' %}#f39c12{% else %}#3498db{% endif %}; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #2c3e50;">{{ rec.titulo }}</h4>
                                        <p style="margin: 0; color: #7f8c8d;">{{ rec.descripcion }}</p>
                                    </div>
                                    <span style="background: {% if rec.impacto == 'Alto' %}#e74c3c{% elif rec.impacto == 'Medio' %}#f39c12{% else %}#3498db{% endif %}; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                        {{ rec.impacto }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- SECCI√ìN PARA PRESENTACIONES AL JEFE -->
                    <div style="margin-top: 40px; border-top: 3px solid #3498db; padding-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="color: #2c3e50; margin: 0;">üéØ Presentaci√≥n para el Jefe (Listo para Mostrar)</h2>
                            <button onclick="imprimirPresentacion()" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                üñ®Ô∏è Imprimir Presentaci√≥n
                            </button>
                        </div>

                        <!-- SLIDE 1: Resumen Ejecutivo -->
                        <div class="slide-presentacion" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; page-break-after: always;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="color: white; margin: 0; font-size: 28px;">üìä SLIDE 1: Resultados Generales</h2>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                                <div style="text-align: center; padding: 25px; background: #ecf0f1; border-radius: 8px;">
                                    <div style="font-size: 48px; font-weight: bold; color: #3498db; margin-bottom: 10px;">{{ total_incidencias }}</div>
                                    <div style="font-size: 18px; color: #2c3e50;">Incidencias Gestionadas</div>
                                    <div style="font-size: 14px; color: #7f8c8d; margin-top: 5px;">100% registradas y seguidas</div>
                                </div>
                                <div style="text-align: center; padding: 25px; background: #ecf0f1; border-radius: 8px;">
                                    <div style="font-size: 48px; font-weight: bold; color: {% if tasa_exito >= 90 %}#27ae60{% elif tasa_exito >= 70 %}#f39c12{% else %}#e74c3c{% endif %}; margin-bottom: 10px;">{{ tasa_exito }}%</div>
                                    <div style="font-size: 18px; color: #2c3e50;">Tasa de √âxito</div>
                                    <div style="font-size: 14px; color: #7f8c8d; margin-top: 5px;">Resueltas en <30 minutos</div>
                                </div>
                                <div style="text-align: center; padding: 25px; background: #ecf0f1; border-radius: 8px;">
                                    <div style="font-size: 48px; font-weight: bold; color: {% if reduccion_porcentual > 0 %}#27ae60{% else %}#e74c3c{% endif %}; margin-bottom: 10px;">{{ reduccion_porcentual }}%</div>
                                    <div style="font-size: 18px; color: #2c3e50;">Reducci√≥n Lograda</div>
                                    <div style="font-size: 14px; color: #7f8c8d; margin-top: 5px;">{{ incidencias_evitadas }} incidencias menos</div>
                                </div>
                                <div style="text-align: center; padding: 25px; background: #ecf0f1; border-radius: 8px;">
                                    <div style="font-size: 48px; font-weight: bold; color: #16a085; margin-bottom: 10px;">{{ cobertura_centros }}%</div>
                                    <div style="font-size: 18px; color: #2c3e50;">Cobertura Total</div>
                                    <div style="font-size: 14px; color: #7f8c8d; margin-top: 5px;">{{ centros_activos }} centros monitoreados</div>
                                </div>
                            </div>
                            <div style="margin-top: 25px; padding: 20px; background: #d5f4e6; border-left: 4px solid #27ae60; border-radius: 6px;">
                                <p style="margin: 0; font-size: 16px; color: #2c3e50; line-height: 1.6;">
                                    <strong>üí° Mensaje Clave:</strong> El equipo ha gestionado {{ total_incidencias }} incidencias con una tasa de √©xito del {{ tasa_exito }}%, 
                                    logrando reducir las incidencias en un {{ reduccion_porcentual }}% con cobertura total en {{ centros_activos }} centros PCC.
                                </p>
                            </div>
                        </div>

                        <!-- SLIDE 2: Eficiencia del Equipo -->
                        <div class="slide-presentacion" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; page-break-after: always;">
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="color: white; margin: 0; font-size: 28px;">‚ö° SLIDE 2: Eficiencia Operativa</h2>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                <div style="text-align: center; padding: 25px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                                    <div style="font-size: 42px; margin-bottom: 10px;">‚öôÔ∏è</div>
                                    <div style="font-size: 36px; font-weight: bold; color: #e67e22; margin-bottom: 10px;">{{ eficiencia_operativa }}</div>
                                    <div style="font-size: 16px; color: #2c3e50;">Incidencias/Hora</div>
                                    <div style="font-size: 13px; color: #7f8c8d; margin-top: 5px;">Productividad del equipo</div>
                                </div>
                                <div style="text-align: center; padding: 25px; background: #d1ecf1; border-radius: 8px; border: 2px solid #17a2b8;">
                                    <div style="font-size: 42px; margin-bottom: 10px;">‚è±Ô∏è</div>
                                    <div style="font-size: 36px; font-weight: bold; color: #3498db; margin-bottom: 10px;">{{ mejora_tiempo_porcentual }}%</div>
                                    <div style="font-size: 16px; color: #2c3e50;">M√°s R√°pidos</div>
                                    <div style="font-size: 13px; color: #7f8c8d; margin-top: 5px;">{{ minutos_ahorrados }} min ahorrados</div>
                                </div>
                                <div style="text-align: center; padding: 25px; background: #d4edda; border-radius: 8px; border: 2px solid #28a745;">
                                    <div style="font-size: 42px; margin-bottom: 10px;">üìä</div>
                                    <div style="font-size: 36px; font-weight: bold; color: #27ae60; margin-bottom: 10px;">{{ horas_trabajo_estimadas }}h</div>
                                    <div style="font-size: 16px; color: #2c3e50;">Horas Invertidas</div>
                                    <div style="font-size: 13px; color: #7f8c8d; margin-top: 5px;">Dedicaci√≥n total</div>
                                </div>
                            </div>
                            <div style="margin-top: 25px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                                <p style="margin: 0; font-size: 16px; color: #2c3e50; line-height: 1.6;">
                                    <strong>üí° Mensaje Clave:</strong> El equipo procesa {{ eficiencia_operativa }} incidencias por hora, 
                                    mejorando su velocidad en un {{ mejora_tiempo_porcentual }}% y ahorrando {{ minutos_ahorrados }} minutos en total.
                                </p>
                            </div>
                        </div>

                        <!-- SLIDE 3: Problemas Identificados -->
                        <div class="slide-presentacion" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; page-break-after: always;">
                            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="color: white; margin: 0; font-size: 28px;">üîç SLIDE 3: Problemas Principales</h2>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px;">Top 3 Causas que Requieren Atenci√≥n:</h3>
                                <div style="display: grid; gap: 15px;">
                                    {% for rec in recomendaciones %}
                                    <div style="display: flex; align-items: center; padding: 20px; background: {% if rec.impacto == 'Alto' %}#fee; border-left: 5px solid #e74c3c{% elif rec.impacto == 'Medio' %}#fef5e7; border-left: 5px solid #f39c12{% else %}#e8f4f8; border-left: 5px solid #3498db{% endif %}; border-radius: 6px;">
                                        <div style="font-size: 48px; margin-right: 20px;">{% if rec.impacto == 'Alto' %}üî¥{% elif rec.impacto == 'Medio' %}üü°{% else %}üîµ{% endif %}</div>
                                        <div style="flex: 1;">
                                            <h4 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 20px;">{{ rec.titulo }}</h4>
                                            <p style="margin: 0; color: #7f8c8d; font-size: 15px;">{{ rec.descripcion }}</p>
                                        </div>
                                        <div style="background: {% if rec.impacto == 'Alto' %}#e74c3c{% elif rec.impacto == 'Medio' %}#f39c12{% else %}#3498db{% endif %}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 14px;">
                                            {{ rec.impacto }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div style="margin-top: 25px; padding: 20px; background: #fee; border-left: 4px solid #e74c3c; border-radius: 6px;">
                                <p style="margin: 0; font-size: 16px; color: #2c3e50; line-height: 1.6;">
                                    <strong>üí° Mensaje Clave:</strong> Hemos identificado {{ recomendaciones|length }} √°reas prioritarias que requieren acci√≥n inmediata 
                                    para reducir a√∫n m√°s las incidencias y mejorar la eficiencia operativa.
                                </p>
                            </div>
                        </div>

                        <!-- SLIDE 4: Pr√≥ximos Pasos -->
                        <div class="slide-presentacion" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); page-break-after: always;">
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h2 style="color: white; margin: 0; font-size: 28px;">üéØ SLIDE 4: Plan de Acci√≥n</h2>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <h3 style="color: #27ae60; margin-bottom: 15px;">‚úÖ Lo que estamos haciendo bien:</h3>
                                    <ul style="list-style: none; padding: 0;">
                                        {% if tasa_exito >= 90 %}
                                        <li style="padding: 12px; background: #d5f4e6; margin-bottom: 10px; border-radius: 6px; font-size: 15px;">
                                            ‚úì Tasa de √©xito del {{ tasa_exito }}% (Excelente)
                                        </li>
                                        {% endif %}
                                        {% if reduccion_porcentual > 10 %}
                                        <li style="padding: 12px; background: #d5f4e6; margin-bottom: 10px; border-radius: 6px; font-size: 15px;">
                                            ‚úì Reducci√≥n del {{ reduccion_porcentual }}% en incidencias
                                        </li>
                                        {% endif %}
                                        {% if mejora_tiempo_porcentual > 10 %}
                                        <li style="padding: 12px; background: #d5f4e6; margin-bottom: 10px; border-radius: 6px; font-size: 15px;">
                                            ‚úì Mejora del {{ mejora_tiempo_porcentual }}% en velocidad
                                        </li>
                                        {% endif %}
                                        <li style="padding: 12px; background: #d5f4e6; margin-bottom: 10px; border-radius: 6px; font-size: 15px;">
                                            ‚úì Cobertura total en {{ centros_activos }} centros PCC
                                        </li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 style="color: #e74c3c; margin-bottom: 15px;">‚ö†Ô∏è √Åreas de mejora:</h3>
                                    <ul style="list-style: none; padding: 0;">
                                        {% if incidencias_recurrentes > incidencias_nuevas %}
                                        <li style="padding: 12px; background: #fee; margin-bottom: 10px; border-radius: 6px; font-size: 15px;">
                                            ! Reducir incidencias recurrentes ({{ incidencias_recurrentes }})
                                        </li>
                                        {% endif %}
                                        {% if tasa_exito < 90 %}
                                        <li style="padding: 12px; background: #fee; margin-bottom: 10px; border-radius: 6px; font-size: 15px;">
                                            ! Mejorar tasa de √©xito (actual: {{ tasa_exito }}%)
                                        </li>
                                        {% endif %}
                                        {% for rec in recomendaciones %}
                                        {% if rec.impacto == 'Alto' %}
                                        <li style="padding: 12px; background: #fee; margin-bottom: 10px; border-radius: 6px; font-size: 15px;">
                                            ! {{ rec.titulo }}
                                        </li>
                                        {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div style="margin-top: 25px; padding: 20px; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 6px;">
                                <p style="margin: 0; font-size: 16px; color: #2c3e50; line-height: 1.6;">
                                    <strong>üí° Mensaje Clave:</strong> Continuaremos fortaleciendo nuestros puntos fuertes mientras trabajamos 
                                    en las √°reas identificadas para alcanzar una eficiencia del 100%.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tabla Detallada -->
                <section class="table-section">
                    <h3>Detalle de Incidencias</h3>
                    <div class="table-controls">
                        <input type="text" id="buscar-tabla" placeholder="üîç Buscar en tabla..." onkeyup="buscarEnTabla()">
                        <button onclick="exportarTablaExcel()" class="btn-export-small">üì• Exportar Tabla</button>
                    </div>
                    <div class="table-wrapper">
                        <table id="tabla-incidencias">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Centro</th>
                                    <th>Par√°metro</th>
                                    <th>Valor</th>
                                    <th>Turno</th>
                                    <th>Tiempo Resoluci√≥n</th>
                                    <th>Persona Llamada</th>
                                    <th>Incidencia</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-body">
                                {% for inc in incidencias %}
                                <tr data-centro="{{ inc.centro.nombre }}" 
                                    data-fecha="{{ inc.fecha_hora|date:'Y-m-d' }}"
                                    data-tipo="{{ inc.tipo_incidencia_normalizada }}"
                                    data-oxigeno-nivel="{{ inc.oxigeno_nivel|default:'' }}"
                                    data-temperatura-nivel="{{ inc.temperatura_nivel|default:'' }}"
                                    data-parametros="{{ inc.parametros_afectados|default:'' }}">
                                    <td>{{ inc.fecha_hora|date:'d-m-Y' }}</td>
                                    <td>{{ inc.centro.nombre }}</td>
                                    <td>{{ inc.parametros_afectados }}</td>
                                    <td>{{ inc.oxigeno_valor|default:inc.temperatura_valor|default:'-' }}</td>
                                    <td>{{ inc.turno }}</td>
                                    <td>{{ inc.tiempo_resolucion }} min</td>
                                    <td>{{ inc.operario_contacto.nombre|default:'N/A' }}</td>
                                    <td>{{ inc.tipo_incidencia_normalizada }}</td>
                                    <td class="obs-cell">{{ inc.observacion|truncatewords:10 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <span id="total-registros">Total: {{ total_incidencias }} registros</span>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // Datos del servidor
        const coordenadasCentros = {{ coordenadas_centros|safe }};
        
        // Inicializar Google Maps
        function initMap() {
            const chile = { lat: -39.6, lng: -72.0 };
            const map = new google.maps.Map(document.getElementById('mapa-google'), {
                zoom: 10,
                center: chile,
                mapTypeId: 'terrain'
            });

            // Agregar marcadores para cada centro
            Object.values(coordenadasCentros).forEach(centro => {
                const marker = new google.maps.Marker({
                    position: { lat: centro.lat, lng: centro.lng },
                    map: map,
                    title: centro.nombre,
                    animation: google.maps.Animation.DROP
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `<div style="padding:10px"><h3>${centro.nombre}</h3><p>Centro PCC</p></div>`
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });
        }

        // Gr√°fico de Barras
        const ctxBarras = document.getElementById('chartBarras').getContext('2d');
        const chartBarras = new Chart(ctxBarras, {
            type: 'bar',
            data: {
                labels: {{ centros_labels|safe }},
                datasets: [{
                    label: 'Ox√≠geno Alto',
                    data: {{ oxigeno_alto_data|safe }},
                    backgroundColor: '#3498db'
                }, {
                    label: 'Ox√≠geno Bajo',
                    data: {{ oxigeno_bajo_data|safe }},
                    backgroundColor: '#e74c3c'
                }, {
                    label: 'Temperatura Baja',
                    data: {{ temperatura_baja_data|safe }},
                    backgroundColor: '#f39c12'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });

        // Mapeo fijo de colores por tipo de incidencia
        const coloresTipos = {
            'Estanque en Tratamiento': '#3498db',      // Azul
            'Estanque en Manejo': '#2ecc71',           // Verde
            'Estanque en manejo': '#2ecc71',           // Verde (variante)
            'Estanque con traslado de peces': '#e74c3c', // Rojo
            'Estanque en Vacunaci√≥n': '#9b59b6',       // Morado
            'Desdoble de estanque': '#1abc9c',         // Turquesa
            'Estanque en flashing': '#34495e',         // Gris oscuro
            'Manipulando sensor': '#f39c12',           // Naranja
            'Sin clasificar': '#95a5a6'                // Gris claro
        };

        // Gr√°fico de Dona
        const ctxDona = document.getElementById('chartDona').getContext('2d');

        const tiposLabels = {{ tipos_labels|safe }};
        const tiposData = {{ tipos_data|safe }};
        
        // Debug
        console.log('Tipos Labels:', tiposLabels);
        console.log('Tipos Data:', tiposData);
        console.log('Total tipos:', tiposLabels.length);

        // Asignar colores seg√∫n tipo
        const tiposColores = tiposLabels.map(tipo => 
            coloresTipos[tipo] || '#95a5a6'  // Color por defecto si no est√° en el mapeo
        );

        const chartDona = new Chart(ctxDona, {
            type: 'doughnut',
            data: {
                labels: tiposLabels,
                datasets: [{
                    data: tiposData,
                    backgroundColor: tiposColores
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });

        // Gr√°fico de Tendencia Temporal
        const ctxTendencia = document.getElementById('chartTendencia').getContext('2d');
        const chartTendencia = new Chart(ctxTendencia, {
            type: 'line',
            data: {
                labels: {{ tendencia_labels|safe }},
                datasets: [{
                    label: 'Incidencias por D√≠a',
                    data: {{ tendencia_data|safe }},
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Gr√°fico de Tiempo de Resoluci√≥n
        const ctxResolucion = document.getElementById('chartResolucion').getContext('2d');
        const chartResolucion = new Chart(ctxResolucion, {
            type: 'bar',
            data: {
                labels: {{ centros_labels|safe }},
                datasets: [{
                    label: 'Tiempo Promedio (min)',
                    data: {{ resolucion_data|safe }},
                    backgroundColor: '#2ecc71'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Mapeo fijo de colores por turno
        const coloresTurnos = {
            'D√≠a': '#3498db',       // Azul
            'Ma√±ana': '#3498db',    // Azul (alias)
            'Tarde': '#e74c3c',     // Rojo
            'Noche': '#f39c12',     // Naranja
            'Sin turno': '#95a5a6'  // Gris
        };

        // Gr√°fico de Turnos
        const ctxTurnos = document.getElementById('chartTurnos').getContext('2d');

        // Datos de turnos desde el backend
        const turnosLabels = {{ turnos_labels|safe }};
        const turnosData = {{ turnos_data|safe }};
        
        // Debug
        console.log('Turnos Labels:', turnosLabels);
        console.log('Turnos Data:', turnosData);

        // Asignar colores seg√∫n el turno
        const turnosColores = turnosLabels.map(turno => {
            if (turno === 'D√≠a' || turno === 'Ma√±ana') return '#3498db';
            if (turno === 'Tarde') return '#e74c3c';
            if (turno === 'Noche') return '#f39c12';
            return '#95a5a6';
        });

        const chartTurnos = new Chart(ctxTurnos, {
            type: 'pie',
            data: {
                labels: turnosLabels,
                datasets: [{
                    data: turnosData,
                    backgroundColor: turnosColores
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // === GR√ÅFICOS DE AN√ÅLISIS Y JUSTIFICACI√ìN ===

        // Gr√°fico de Causas Ra√≠z
        const ctxCausas = document.getElementById('chartCausasRaiz').getContext('2d');
        const chartCausasRaiz = new Chart(ctxCausas, {
            type: 'bar',
            data: {
                labels: {{ causas_labels|safe }},
                datasets: [{
                    label: 'Cantidad de Incidencias',
                    data: {{ causas_count|safe }},
                    backgroundColor: '#e74c3c',
                    yAxisID: 'y'
                }, {
                    label: 'Tiempo Promedio (min)',
                    data: {{ causas_tiempo|safe }},
                    backgroundColor: '#3498db',
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Cantidad' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Tiempo (min)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // Gr√°fico de Cumplimiento SLA
        const ctxSLA = document.getElementById('chartSLA').getContext('2d');
        const chartSLA = new Chart(ctxSLA, {
            type: 'bar',
            data: {
                labels: {{ centros_labels|safe }},
                datasets: [{
                    label: 'Tiempo Promedio (min)',
                    data: {{ tiempos_por_centro|safe }},
                    backgroundColor: {{ tiempos_por_centro|safe }}.map(t => t <= {{ tiempo_objetivo }} ? '#27ae60' : '#e74c3c')
                }, {
                    label: '% Cumplimiento SLA',
                    data: {{ cumplimiento_sla|safe }},
                    backgroundColor: '#3498db',
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: {{ tiempo_objetivo }},
                                yMax: {{ tiempo_objetivo }},
                                borderColor: '#f39c12',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Objetivo SLA',
                                    enabled: true
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Tiempo (min)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: '% Cumplimiento' },
                        max: 100,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // Gr√°fico de Mejora Mensual
        const ctxMejora = document.getElementById('chartMejora').getContext('2d');
        const chartMejora = new Chart(ctxMejora, {
            type: 'line',
            data: {
                labels: {{ mejora_labels|safe }},
                datasets: [{
                    label: 'Total Incidencias',
                    data: {{ mejora_total|safe }},
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: 'Tiempo Promedio Respuesta (min)',
                    data: {{ mejora_tiempo|safe }},
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Cantidad Incidencias' },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Tiempo (min)' },
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // Gr√°fico de Recurrencia
        const ctxRecurrencia = document.getElementById('chartRecurrencia').getContext('2d');
        const chartRecurrencia = new Chart(ctxRecurrencia, {
            type: 'doughnut',
            data: {
                labels: ['Recurrentes', 'Nuevas'],
                datasets: [{
                    data: [{{ incidencias_recurrentes }}, {{ incidencias_nuevas }}],
                    backgroundColor: ['#e74c3c', '#27ae60']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed;
                                let total = {{ incidencias_recurrentes }} + {{ incidencias_nuevas }};
                                let percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // Datos originales para filtrado
        let datosOriginales = {
            centros: {{ centros_labels|safe }},
            oxigenoAltoData: {{ oxigeno_alto_data|safe }},
            oxigenoBajoData: {{ oxigeno_bajo_data|safe }},
            temperaturaBajaData: {{ temperatura_baja_data|safe }},
            resolucionData: {{ resolucion_data|safe }}
        };

        // Funciones de filtrado
        function toggleTodosCentros() {
            const todosCentros = document.getElementById('todos-centros').checked;
            document.querySelectorAll('.filter-centro').forEach(cb => cb.checked = todosCentros);
            filtrarDatos();
        }

        function toggleTodosTipos() {
            const todosTipos = document.getElementById('todos-tipos').checked;
            document.querySelectorAll('.filter-tipo').forEach(cb => cb.checked = todosTipos);
            filtrarDatos();
        }

        function filtrarDatos() {
            const centrosSeleccionados = Array.from(document.querySelectorAll('.filter-centro:checked')).map(cb => cb.value);
            const todosCentros = centrosSeleccionados.length === document.querySelectorAll('.filter-centro').length;
            const mes = document.getElementById('filtro-mes').value;
            const tiposSeleccionados = Array.from(document.querySelectorAll('.filter-tipo:checked')).map(cb => cb.value);
            const todosTipos = tiposSeleccionados.length === document.querySelectorAll('.filter-tipo').length;
            
            const tabla = document.getElementById('tabla-incidencias');
            const filas = tabla.querySelectorAll('tbody tr');
            let totalVisible = 0;
            
            let totalIncidencias = 0;
            let oxigenoAlto = 0;
            let oxigenoBajo = 0;
            let temperaturaBaja = 0;
            let centrosCount = {};
            
            filas.forEach(fila => {
                const centro = fila.dataset.centro;
                const fecha = fila.dataset.fecha;
                const oxigenoNivel = fila.dataset.oxigenoNivel;
                const temperaturaNivel = fila.dataset.temperaturaNivel;
                
                let mostrar = true;
                
                if (!todosCentros && !centrosSeleccionados.includes(centro)) {
                    mostrar = false;
                }
                
                if (mes !== 'todos' && fecha) {
                    const mesFila = new Date(fecha).getMonth() + 1;
                    if (mesFila.toString() !== mes) {
                        mostrar = false;
                    }
                }
                
                if (!todosTipos && tiposSeleccionados.length > 0) {
                    let cumpleFiltro = false;
                    tiposSeleccionados.forEach(filtro => {
                        if (filtro === 'Ox√≠geno Alto' && oxigenoNivel === 'alta') cumpleFiltro = true;
                        if (filtro === 'Ox√≠geno Bajo' && oxigenoNivel === 'baja') cumpleFiltro = true;
                        if (filtro === 'Temperatura Baja' && temperaturaNivel === 'baja') cumpleFiltro = true;
                    });
                    if (!cumpleFiltro) mostrar = false;
                }
                
                if (mostrar) {
                    fila.style.display = '';
                    totalVisible++;
                    totalIncidencias++;
                    if (oxigenoNivel === 'alta') oxigenoAlto++;
                    if (oxigenoNivel === 'baja') oxigenoBajo++;
                    if (temperaturaNivel === 'baja') temperaturaBaja++;
                    centrosCount[centro] = (centrosCount[centro] || 0) + 1;
                } else {
                    fila.style.display = 'none';
                }
            });
            
            document.getElementById('kpi-total').textContent = totalIncidencias;
            document.getElementById('kpi-oxigeno-alto').textContent = oxigenoAlto;
            document.getElementById('kpi-oxigeno-bajo').textContent = oxigenoBajo;
            document.getElementById('kpi-temperatura-baja').textContent = temperaturaBaja;
            
            let centroTop = 'N/A';
            let maxCount = 0;
            for (let centro in centrosCount) {
                if (centrosCount[centro] > maxCount) {
                    maxCount = centrosCount[centro];
                    centroTop = `${centro} - ${maxCount}`;
                }
            }
            document.getElementById('kpi-centro-top').textContent = centroTop;
            document.getElementById('total-registros').textContent = `Total: ${totalVisible} registros`;
            
            let tituloCentro = todosCentros ? 'Todos los Centros' : centrosSeleccionados.join(', ');
            document.getElementById('centro-actual').textContent = tituloCentro;
            
            // Actualizar gr√°ficos din√°micamente
            actualizarGraficos(centrosSeleccionados, todosCentros, centrosCount);
        }

        function actualizarGraficos(centrosSeleccionados, todosCentros, centrosCount) {
            // Actualizar gr√°fico de barras por centro
            let centrosLabels = [];
            let oxigenoAltoData = [];
            let oxigenoBajoData = [];
            let temperaturaBajaData = [];
            
            datosOriginales.centros.forEach((centro, index) => {
                if (todosCentros || centrosSeleccionados.includes(centro)) {
                    centrosLabels.push(centro);
                    oxigenoAltoData.push(datosOriginales.oxigenoAltoData[index]);
                    oxigenoBajoData.push(datosOriginales.oxigenoBajoData[index]);
                    temperaturaBajaData.push(datosOriginales.temperaturaBajaData[index]);
                }
            });
            
            chartBarras.data.labels = centrosLabels;
            chartBarras.data.datasets[0].data = oxigenoAltoData;
            chartBarras.data.datasets[1].data = oxigenoBajoData;
            chartBarras.data.datasets[2].data = temperaturaBajaData;
            chartBarras.update();
            
            // Actualizar gr√°fico de resoluci√≥n
            let resolucionData = [];
            datosOriginales.centros.forEach((centro, index) => {
                if (todosCentros || centrosSeleccionados.includes(centro)) {
                    resolucionData.push(datosOriginales.resolucionData[index]);
                }
            });
            
            chartResolucion.data.labels = centrosLabels;
            chartResolucion.data.datasets[0].data = resolucionData;
            chartResolucion.update();
            
            // Recalcular datos desde las filas visibles de la tabla para otros gr√°ficos
            const tabla = document.getElementById('tabla-incidencias');
            const filasVisibles = Array.from(tabla.querySelectorAll('tbody tr')).filter(fila => fila.style.display !== 'none');
            
            // Datos para gr√°fico de dona (tipos de incidencia)
            let tiposCount = {};
            filasVisibles.forEach(fila => {
                const tipo = fila.dataset.tipo || 'Sin clasificar';
                tiposCount[tipo] = (tiposCount[tipo] || 0) + 1;
            });
            
            // Ordenar por cantidad - MOSTRAR TODOS LOS TIPOS
            let tiposArray = Object.entries(tiposCount).sort((a, b) => b[1] - a[1]);
            let tiposLabels = tiposArray.map(t => t[0]);
            let tiposData = tiposArray.map(t => t[1]);
            
            // Asignar colores consistentes seg√∫n tipo
            let tiposColoresActualizados = tiposLabels.map(tipo => 
                coloresTipos[tipo] || '#95a5a6'
            );
            
            chartDona.data.labels = tiposLabels;
            chartDona.data.datasets[0].data = tiposData;
            chartDona.data.datasets[0].backgroundColor = tiposColoresActualizados;
            chartDona.update();
            
            // Datos para gr√°fico de tendencia temporal
            let fechasCount = {};
            filasVisibles.forEach(fila => {
                const fecha = fila.dataset.fecha;
                if (fecha) {
                    fechasCount[fecha] = (fechasCount[fecha] || 0) + 1;
                }
            });
            
            // Ordenar por fecha
            let fechasArray = Object.entries(fechasCount).sort((a, b) => new Date(a[0]) - new Date(b[0]));
            let tendenciaLabels = fechasArray.map(f => {
                const date = new Date(f[0]);
                return date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
            });
            let tendenciaData = fechasArray.map(f => f[1]);
            
            chartTendencia.data.labels = tendenciaLabels;
            chartTendencia.data.datasets[0].data = tendenciaData;
            chartTendencia.update();
            
            // Datos para gr√°fico de turnos
            let turnosCount = {};
            filasVisibles.forEach(fila => {
                const celdas = fila.querySelectorAll('td');
                if (celdas.length >= 5) {
                    const turno = celdas[4].textContent.trim() || 'Sin turno';
                    turnosCount[turno] = (turnosCount[turno] || 0) + 1;
                }
            });
            
            // Ordenar turnos de forma consistente - RECONOCER D√çA Y MA√ëANA
            const turnosOrden = ['D√≠a', 'Ma√±ana', 'Tarde', 'Noche', 'Sin turno'];
            let turnosLabels = [];
            let turnosData = [];
            let turnosColores = [];

            turnosOrden.forEach(turno => {
                if (turnosCount[turno] && turnosCount[turno] > 0) {
                    turnosLabels.push(turno);
                    turnosData.push(turnosCount[turno]);
                    // Usar el color correcto para D√≠a/Ma√±ana
                    const color = (turno === 'D√≠a' || turno === 'Ma√±ana') ? '#3498db' : 
                                  (turno === 'Tarde') ? '#e74c3c' : 
                                  (turno === 'Noche') ? '#f39c12' : '#95a5a6';
                    turnosColores.push(color);
                }
            });
            
            chartTurnos.data.labels = turnosLabels;
            chartTurnos.data.datasets[0].data = turnosData;
            chartTurnos.data.datasets[0].backgroundColor = turnosColores;
            chartTurnos.update();
        }

        function resetearFiltros() {
            document.getElementById('todos-centros').checked = true;
            document.getElementById('todos-tipos').checked = true;
            document.querySelectorAll('.filter-centro').forEach(cb => cb.checked = true);
            document.querySelectorAll('.filter-tipo').forEach(cb => cb.checked = true);
            document.getElementById('filtro-mes').value = 'todos';
            filtrarDatos();
        }

        function buscarEnTabla() {
            const input = document.getElementById('buscar-tabla');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('tabla-incidencias');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                if (tr[i].style.display !== 'none') {
                    let txtValue = tr[i].textContent || tr[i].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        function exportarTablaExcel() {
            const table = document.getElementById('tabla-incidencias');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Incidencias"});
            XLSX.writeFile(wb, 'Incidencias_Detalle.xlsx');
        }

        function exportarExcel() {
            exportarTablaExcel();
        }

        function imprimirPresentacion() {
            // Ocultar elementos que no queremos imprimir
            const filtros = document.querySelector('.filters-panel');
            const tabla = document.querySelector('.table-section');
            const graficos = document.querySelectorAll('.charts-section, .charts-grid-extended');
            const mapa = document.querySelector('.map-section');
            
            // Guardar display original
            const originalDisplays = [];
            [filtros, tabla, mapa, ...graficos].forEach(el => {
                if (el) {
                    originalDisplays.push(el.style.display);
                    el.style.display = 'none';
                }
            });
            
            // Imprimir
            window.print();
            
            // Restaurar display original
            let index = 0;
            [filtros, tabla, mapa, ...graficos].forEach(el => {
                if (el) {
                    el.style.display = originalDisplays[index];
                    index++;
                }
            });
        }

        // Inicializar mapa y filtros
        window.onload = function() {
            initMap();
            filtrarDatos();
        };
    </script>
    <style media="print">
        @page {
            size: landscape;
            margin: 1cm;
        }
        .slide-presentacion {
            page-break-after: always;
            page-break-inside: avoid;
        }
        .filters-panel, .table-section, .charts-section, .charts-grid-extended, .map-section {
            display: none !important;
        }
        .btn-back, .btn-export {
            display: none !important;
        }
    </style>
</body>
<!-- Version: 2026-01-30-2012 - CORREGIDO: actualizarGraficos ahora reconoce turno D√≠a, meta tags no-cache -->
</html>
