{% extends 'base_sidebar.html' %}
{% load static %}

{% block title %}{% if incidencia_a_editar %}Editar Incidencia{% else %}Formulario PCC{% endif %}{% endblock %}
{% block page_title %}{% if incidencia_a_editar %}Editar Incidencia{% else %}Formulario de Incidencias PCC{% endif %}{% endblock %}
{% block page_subtitle %}Registro de par√°metros en m√≥dulos y estanques{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/formulario.css' %}">
<style>
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        max-width: 900px;
    }
    .form-container h1 { display: none; }
    .form-logo { max-height: 60px; }
    .page-layout { display: block; }
    .sidebar-actions { display: none; }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border-left: 4px solid #00b4d8;
    }
    .form-section h2 {
        color: #1e3a5f;
        font-size: 1.2em;
        margin: 0 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }
    .form-section h3 {
        color: #1e3a5f;
        font-size: 1em;
        margin: 15px 0 10px 0;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 6px;
        font-size: 0.9em;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.3s;
        box-sizing: border-box;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: #00b4d8;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.1);
    }
    .form-group-radio {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        background: white;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
    }
    .form-group-radio:hover {
        background: #e9ecef;
    }
    .form-group-radio input[type="radio"] {
        width: auto;
    }
    .form-group-radio label {
        margin: 0;
        cursor: pointer;
    }
    .hidden { display: none !important; }
    .hidden-input { display: none; }
    
    .parametros-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    .parametro-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        transition: all 0.3s;
    }
    .parametro-card:hover {
        border-color: #00b4d8;
        box-shadow: 0 4px 12px rgba(0, 180, 216, 0.15);
    }
    .parametro-card.active {
        border-color: #00b4d8;
        background: #f0f9ff;
    }
    .parametro-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .parametro-header input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    .parametro-header label {
        font-weight: 600;
        color: #1e3a5f;
        margin: 0;
        cursor: pointer;
        font-size: 1em;
    }
    .parametro-fields {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .parametro-fields .field-group {
        display: flex;
        flex-direction: column;
    }
    .parametro-fields label {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 5px;
        display: block;
    }
    .parametro-fields select,
    .parametro-fields input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.95em;
    }
    #submitForm {
        width: 100%;
        padding: 15px 30px;
        background: linear-gradient(135deg, #00b4d8, #0077b6);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
    }
    #submitForm:hover {
        box-shadow: 0 6px 20px rgba(0, 180, 216, 0.4);
        transform: translateY(-2px);
    }
    .form-section-visible { display: block; }
</style>
{% endblock %}

{% block header_actions %}
<a href="{% url 'reporte' %}" class="header-btn">
    <i class="fas fa-list"></i> Ver Reportes
</a>
{% endblock %}

{% block content %}
<div class="form-container">
    <div style="text-align: right; margin-bottom: 20px;">
        <img src="{% static 'imagenes/logo-reporte-cermaq.png' %}" alt="Logo" class="form-logo">
    </div>

    <form id="incidenciaForm" data-incidencia-id="{{ incidencia_a_editar.pk|default:'' }}">
        {% csrf_token %}
        
        <section class="form-section {% if incidencia_a_editar %}form-section-visible{% endif %}" id="section-info-basica">
            <h2>1. Informaci√≥n B√°sica del Reporte</h2>
            <div class="form-group">
                <label for="fechaHora">Fecha y Hora:</label>
                <input type="datetime-local" id="fechaHora" name="fechaHora" value="{{ incidencia_a_editar.fecha_hora|date:'Y-m-d\TH:i' }}" required>
            </div>
            <div class="form-group">
                <label for="turno">Turno:</label>
                <select id="turno" name="turno" required>
                    <option value="">Seleccione un turno</option>
                    <option value="Ma√±ana" {% if incidencia_a_editar.turno == 'Ma√±ana' %}selected{% endif %}>Ma√±ana</option>
                    <option value="Tarde" {% if incidencia_a_editar.turno == 'Tarde' %}selected{% endif %}>Tarde</option>
                    <option value="Noche" {% if incidencia_a_editar.turno == 'Noche' %}selected{% endif %}>Noche</option>
                </select>
            </div>
            <div class="form-group">
                <label for="centro">Centro:</label>
                <select id="centro" name="centro" required>
                    <option value="">Seleccione un centro</option>
                    {% for c in centros %}
                    <option value="{{ c.id }}" {% if incidencia_a_editar.centro_id == c.id %}selected{% endif %}>{{ c.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </section>

        <section class="form-section {% if not incidencia_a_editar %}hidden{% endif %}" id="section-modulos-estanques">
            <h2>2. Ubicaci√≥n: M√≥dulo y Estanque</h2>
            <div class="form-group">
                <label for="modulo">M√≥dulo:</label>
                <select id="modulo" name="modulo"><option value="">Seleccione un m√≥dulo</option></select>
            </div>
            <div class="form-group">
                <label for="estanque">Estanque:</label>
                <select id="estanque" name="estanque"><option value="">Seleccione un estanque</option></select>
            </div>
            <h3>Par√°metros Afectados:</h3>
            <div class="parametros-grid">
                <div class="parametro-card" id="card-oxigeno">
                    <div class="parametro-header">
                        <input type="checkbox" id="oxigeno" name="parametros" value="oxigeno">
                        <label for="oxigeno">üíß Ox√≠geno</label>
                    </div>
                    <div class="parametro-fields hidden-input">
                        <div class="field-group">
                            <label for="oxigenoNivel">Nivel:</label>
                            <select id="oxigenoNivel" name="oxigenoNivel">
                                <option value="">Seleccione nivel</option>
                                <option value="alta" {% if incidencia_a_editar.oxigeno_nivel == 'alta' %}selected{% endif %}>Alto</option>
                                <option value="baja" {% if incidencia_a_editar.oxigeno_nivel == 'baja' %}selected{% endif %}>Bajo</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="valorOxigeno">Valor:</label>
                            <input type="text" id="valorOxigeno" name="valorOxigeno" placeholder="Ej: 12,2 mg/L" inputmode="decimal" value="{{ incidencia_a_editar.oxigeno_valor }}">
                        </div>
                    </div>
                </div>
                
                <div class="parametro-card" id="card-temperatura">
                    <div class="parametro-header">
                        <input type="checkbox" id="temperatura" name="parametros" value="temperatura">
                        <label for="temperatura">üå°Ô∏è Temperatura</label>
                    </div>
                    <div class="parametro-fields hidden-input">
                        <div class="field-group">
                            <label for="temperaturaNivel">Nivel:</label>
                            <select id="temperaturaNivel" name="temperaturaNivel">
                                <option value="">Seleccione nivel</option>
                                <option value="alta" {% if incidencia_a_editar.temperatura_nivel == 'alta' %}selected{% endif %}>Alto</option>
                                <option value="baja" {% if incidencia_a_editar.temperatura_nivel == 'baja' %}selected{% endif %}>Bajo</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="valorTemperatura">Valor:</label>
                            <input type="text" id="valorTemperatura" name="valorTemperatura" placeholder="Ej: 12,2 ¬∞C" inputmode="decimal" value="{{ incidencia_a_editar.temperatura_valor }}">
                        </div>
                    </div>
                </div>
                
                <div class="parametro-card" id="card-conductividad">
                    <div class="parametro-header">
                        <input type="checkbox" id="conductividad" name="parametros" value="conductividad">
                        <label for="conductividad">‚ö° Conductividad</label>
                    </div>
                    <div class="parametro-fields hidden-input">
                        <div class="field-group">
                            <label for="conductividadNivel">Nivel:</label>
                            <select id="conductividadNivel" name="conductividadNivel">
                                <option value="">Seleccione nivel</option>
                                <option value="alta" {% if incidencia_a_editar.conductividad_nivel == 'alta' %}selected{% endif %}>Alto</option>
                                <option value="baja" {% if incidencia_a_editar.conductividad_nivel == 'baja' %}selected{% endif %}>Bajo</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="parametro-card" id="card-turbidez">
                    <div class="parametro-header">
                        <input type="checkbox" id="turbidez" name="parametros" value="turbidez">
                        <label for="turbidez">üå´Ô∏è Turbidez</label>
                    </div>
                    <div class="parametro-fields hidden-input">
                        <div class="field-group">
                            <label for="turbidezNivel">Nivel:</label>
                            <select id="turbidezNivel" name="turbidezNivel">
                                <option value="">Seleccione nivel</option>
                                <option value="alta" {% if incidencia_a_editar.turbidez_nivel == 'alta' %}selected{% endif %}>Alto</option>
                                <option value="baja" {% if incidencia_a_editar.turbidez_nivel == 'baja' %}selected{% endif %}>Bajo</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="valorTurbidez">Valor:</label>
                            <input type="text" id="valorTurbidez" name="valorTurbidez" placeholder="Ej: 12,2 NTU" inputmode="decimal" value="{{ incidencia_a_editar.turbidez_valor }}">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="form-section {% if not incidencia_a_editar %}hidden{% endif %}" id="section-evaluacion-riesgos">
            <h2>3. Evaluaci√≥n de Riesgos y Observaciones</h2>
            <div class="form-group">
                <label for="tiempoResolucion">Tiempo de Resoluci√≥n Estimado (minutos):</label>
                <input type="number" id="tiempoResolucion" name="tiempoResolucion" value="{{ incidencia_a_editar.tiempo_resolucion }}" min="0" required>
            </div>
            <div class="form-group">
                <label for="riesgoPeces">Riesgo para Peces:</label>
                <select id="riesgoPeces" name="riesgoPeces" required>
                    <option value="">Seleccione</option>
                    <option value="si" {% if incidencia_a_editar.riesgo_peces %}selected{% endif %}>S√≠</option>
                    <option value="no" {% if not incidencia_a_editar.riesgo_peces and incidencia_a_editar is not None %}selected{% endif %}>No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="perdidaEconomica">P√©rdida Econ√≥mica:</label>
                <select id="perdidaEconomica" name="perdidaEconomica" required>
                    <option value="">Seleccione</option>
                    <option value="si" {% if incidencia_a_editar.perdida_economica %}selected{% endif %}>S√≠</option>
                    <option value="no" {% if not incidencia_a_editar.perdida_economica and incidencia_a_editar is not None %}selected{% endif %}>No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="riesgoPersonas">Riesgo para Personas:</label>
                <select id="riesgoPersonas" name="riesgoPersonas" required>
                    <option value="">Seleccione</option>
                    <option value="si" {% if incidencia_a_editar.riesgo_personas %}selected{% endif %}>S√≠</option>
                    <option value="no" {% if not incidencia_a_editar.riesgo_personas and incidencia_a_editar is not None %}selected{% endif %}>No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="observacion">Observaci√≥n Adicional:</label>
                <textarea id="observacion" name="observacion" rows="4" placeholder="Describa cualquier detalle relevante...">{{ incidencia_a_editar.observacion|default:'' }}</textarea>
            </div>
        </section>

        <section class="form-section {% if not incidencia_a_editar %}hidden{% endif %}" id="section-contacto-operario">
            <h2>4. Contacto del Operario que Respondi√≥</h2>
            <div class="form-group">
                <label for="operarioContacto">Operario que Respondi√≥:</label>
                <select id="operarioContacto" name="operarioContacto"><option value="">Seleccione un operario</option></select>
            </div>
            <div class="form-group info-operario-hidden" id="info-operario-selected">
                <label>Informaci√≥n del Operario:</label>
                <div id="operario-info-display" class="operario-info">
                    <p><strong>Nombre:</strong> <span id="operario-nombre-display"></span></p>
                    <p><strong>Cargo:</strong> <span id="operario-cargo-display"></span></p>
                    <p><strong>Tel√©fono:</strong> <span id="operario-telefono-display"></span></p>
                </div>
            </div>
            <div class="form-group">
                <label for="tipoIncidenciaNormalizada">Tipo de Incidencia Normalizada:</label>
                <select id="tipoIncidenciaNormalizada" name="tipoIncidenciaNormalizada" required>
                    <option value="">Seleccione el tipo de incidencia</option>
                    <optgroup label="Manejo Operacional">
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque en Tratamiento' %}selected{% endif %}>Estanque en Tratamiento</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque en Manejo' %}selected{% endif %}>Estanque en Manejo</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque con traslado de peces' %}selected{% endif %}>Estanque con traslado de peces</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque en Flashing' %}selected{% endif %}>Estanque en Flashing</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque en Vacunaci√≥n' %}selected{% endif %}>Estanque en Vacunaci√≥n</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Desdoble de estanque' %}selected{% endif %}>Desdoble de estanque</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Recambio de agua' %}selected{% endif %}>Recambio de agua</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque vac√≠o' %}selected{% endif %}>Estanque vac√≠o</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque en selecci√≥n' %}selected{% endif %}>Estanque en selecci√≥n</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Estanque en ayuna' %}selected{% endif %}>Estanque en ayuna</option>
                    </optgroup>
                    <optgroup label="Problemas de Sensores">
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Manipulando sensor' %}selected{% endif %}>Manipulando sensor</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Falla sensor CO2' %}selected{% endif %}>Falla sensor CO2</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Falla sensor T¬∞' %}selected{% endif %}>Falla sensor T¬∞</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Falla sensor pH' %}selected{% endif %}>Falla sensor pH</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Problemas con la TEMPERATURA' %}selected{% endif %}>Problemas con la TEMPERATURA</option>
                    </optgroup>
                    <optgroup label="Problemas El√©ctricos / Conectividad">
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Corte de energ√≠a' %}selected{% endif %}>Corte de energ√≠a</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Corte de luz' %}selected{% endif %}>Corte de luz</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Falla en plataforma de monitoreo' %}selected{% endif %}>Falla en plataforma de monitoreo</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Problemas con la plataforma' %}selected{% endif %}>Problemas con la plataforma</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Sin se√±al o conectividad' %}selected{% endif %}>Sin se√±al o conectividad</option>
                    </optgroup>
                    <optgroup label="Problemas Operacionales Espec√≠ficos">
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Problemas con el cono de oxigenaci√≥n' %}selected{% endif %}>Problemas con el cono de oxigenaci√≥n</option>
                    </optgroup>
                    <optgroup label="Par√°metros Fuera de Rango">
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Temperatura baja' %}selected{% endif %}>Temperatura baja</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Temperatura alta' %}selected{% endif %}>Temperatura alta</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'CO2 alto' %}selected{% endif %}>CO2 alto</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'CO2 bajo' %}selected{% endif %}>CO2 bajo</option>
                    </optgroup>
                    <optgroup label="Comunicaci√≥n">
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Sin respuesta del centro' %}selected{% endif %}>Sin respuesta del centro</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Llamada no contestada' %}selected{% endif %}>Llamada no contestada</option>
                        <option {% if incidencia_a_editar.tipo_incidencia_normalizada == 'Celular centro apagado' %}selected{% endif %}>Celular centro apagado</option>
                    </optgroup>
                </select>
            </div>
        </section>

        <button type="button" id="submitForm">
            {% if incidencia_a_editar %}Actualizar Incidencia{% else %}Registrar Incidencia{% endif %}
        </button>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>window.DATOS_MODULOS = {{ datos_modulos_json|safe }};</script>
<script>window.DATOS_OPERARIOS = {{ datos_operarios_json|safe }};</script>
<script>window.INCIDENCIA_A_EDITAR = {{ incidencia_a_editar_json|safe }};</script>
<script src="{% static 'js/formulario.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fechaHoraInput = document.getElementById('fechaHora');
    // Solo auto-llenar si no hay valor (formulario nuevo, no edici√≥n)
    if (fechaHoraInput && !fechaHoraInput.value) {
        const now = new Date();
        // Ajustar a zona horaria Chile (UTC-3)
        const offset = now.getTimezoneOffset() * 60000;
        const localTime = new Date(now.getTime() - offset);
        fechaHoraInput.value = localTime.toISOString().slice(0, 16);
    }
});
</script>
{% endblock %}
