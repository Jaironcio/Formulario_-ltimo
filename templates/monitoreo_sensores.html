{% extends 'base_sidebar.html' %}
{% load static %}

{% block title %}Monitoreo Sensores{% endblock %}
{% block page_title %}Monitoreo de Sensores - Ideal Control{% endblock %}
{% block page_subtitle %}Registro diario de estado de sensores por centro y sistema{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/formulario.css' %}">
<style>
    .sensor-section { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #008b8b; }
    .sensor-section h3 { color: #008b8b; display: flex; align-items: center; gap: 12px; font-size: 18px; margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
    .section-icon { background: #008b8b; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 600; margin-bottom: 8px; color: #333; font-size: 0.9em; }
    .form-group input, .form-group select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    .form-group select:disabled { background-color: #f5f5f5; cursor: not-allowed; }
    .sensor-table { width: 100%; border-collapse: collapse; margin-top: 20px; display: none; }
    .sensor-table.show { display: table; }
    .sensor-table th { background: linear-gradient(135deg, #1e3a5f 0%, #0a1929 100%); color: white; padding: 12px; text-align: left; font-weight: 600; font-size: 0.85em; }
    .sensor-table td { padding: 12px; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; }
    .sensor-table tr:hover { background-color: #f8f9fa; }
    .estado-radio { display: flex; gap: 15px; align-items: center; }
    .estado-radio label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: normal; font-size: 0.85em; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #00b4d8, #0077b6); color: white; }
    .btn-primary:hover { box-shadow: 0 4px 15px rgba(0,180,216,0.4); transform: translateY(-2px); }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .button-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .session-list { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .session-item { background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #00b4d8; display: flex; justify-content: space-between; align-items: center; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .badge-normal { background: #28a745; color: white; }
    .badge-alto { background: #dc3545; color: white; }
    .badge-bajo { background: #ffc107; color: #333; }
    .loading { text-align: center; padding: 20px; color: #6c757d; }
    .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .alert-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .section-blue { border-left-color: #17a2b8; }
    .section-blue h3 { color: #17a2b8; }
    .section-blue .section-icon { background: #17a2b8; }
    .section-purple { border-left-color: #6f42c1; }
    .section-purple h3 { color: #6f42c1; }
    .section-purple .section-icon { background: #6f42c1; }
    .section-green { border-left-color: #28a745; }
    .section-green h3 { color: #28a745; }
    .section-green .section-icon { background: #28a745; }
</style>
{% endblock %}

{% block header_actions %}
<a href="{% url 'consulta_sensores' %}" class="header-btn">
    <i class="fas fa-list"></i> Ver Reportes
</a>
{% endblock %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div id="alertContainer"></div>

<div class="sensor-section">
    <h3><span class="section-icon">üìã</span> Informaci√≥n General del Reporte</h3>
    <div class="form-grid">
        <div class="form-group">
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" value="{{ fecha_hoy|date:'Y-m-d' }}" required>
        </div>
        <div class="form-group">
            <label for="turno">Turno:</label>
            <select id="turno" required>
                <option value="">Seleccione turno</option>
                <option value="MA√ëANA">Ma√±ana (08:30 - 17:30)</option>
                <option value="TARDE">Tarde (14:30 - 00:00)</option>
                <option value="NOCHE">Noche (00:00 - 09:30)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="responsable">Responsable:</label>
            <input type="text" id="responsable" placeholder="Nombre del responsable" required>
        </div>
    </div>
</div>

<div class="sensor-section section-blue">
    <h3><span class="section-icon">üè¢</span> Selecci√≥n de Centro y Sistema</h3>
    <div class="form-grid">
        <div class="form-group">
            <label for="centro">Centro:</label>
            <select id="centro">
                <option value="">Seleccione centro</option>
                {% for centro in centros %}<option value="{{ centro.id }}">{{ centro.nombre }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="sistema">Sistema:</label>
            <select id="sistema" disabled><option value="">Primero seleccione un centro</option></select>
        </div>
    </div>
    <div class="button-group">
        <button type="button" class="btn btn-primary" id="cargarSensoresBtn" disabled>Cargar Sensores del Sistema</button>
    </div>
</div>

<div class="sensor-section section-purple">
    <h3><span class="section-icon">üìä</span> Sensores del Sistema</h3>
    <div id="loadingMessage" class="loading" style="display: none;">Cargando sensores...</div>
    <table class="sensor-table" id="sensoresTable">
        <thead>
            <tr>
                <th>Equipo/Sensor</th>
                <th>Tipo de Medici√≥n</th>
                <th>L√≠mites</th>
                <th>Estado</th>
                <th>Observaci√≥n</th>
            </tr>
        </thead>
        <tbody id="sensoresTableBody"></tbody>
    </table>
    <div class="button-group">
        <button type="button" class="btn btn-success" id="agregarAReporteBtn" style="display: none;">‚úì Agregar a Reporte</button>
    </div>
</div>

<div class="sensor-section section-green">
    <h3><span class="section-icon">üìù</span> Sensores Agregados al Reporte</h3>
    <div id="sessionList" class="session-list">
        <p style="text-align: center; color: #6c757d;">No hay sensores agregados a√∫n</p>
    </div>
    <div class="button-group">
        <button type="button" class="btn btn-success" id="guardarReporteBtn" style="display: none;">üíæ Guardar Reporte Completo</button>
        <button type="button" class="btn btn-warning" id="generarPDFBtn" style="display: none;">üìÑ Generar PDF</button>
        <button type="button" class="btn btn-secondary" id="limpiarSesionBtn" style="display: none;">üóëÔ∏è Limpiar Todo</button>
    </div>
</div>

<div id="modalReportes" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 50px auto; background: white; border-radius: 12px; padding: 30px; position: relative;">
        <button id="cerrarModalBtn" style="position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;">‚úï Cerrar</button>
        <h2 style="color: #008b8b; margin-bottom: 20px;">üìã Reportes de Sensores Registrados</h2>
        <div id="loadingReportes" style="text-align: center; padding: 40px; display: none;"><p>Cargando reportes...</p></div>
        <div id="listaReportes" style="margin-top: 20px;"></div>
        <div id="detalleReporte" style="display: none; margin-top: 30px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
            <button id="volverListaBtn" class="btn btn-secondary" style="margin-bottom: 15px;">‚Üê Volver a la Lista</button>
            <h3 id="tituloDetalle" style="color: #008b8b; margin-bottom: 20px;"></h3>
            <div id="contenidoDetalle"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="{% static 'js/monitoreo_sensores.js' %}"></script>
{% endblock %}
