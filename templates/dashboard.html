{% extends 'base_sidebar.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard de Incidencias{% endblock %}
{% block page_subtitle %}M√©tricas de cumplimiento y rendimiento operativo{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/formulario.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    .page-layout, .sidebar-actions { display: none !important; }
    .dashboard-container { max-width: 100%; }
    .dashboard-container h1 { display: none; }
    .dashboard-controls { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: flex-end; background: #f8f9fa; padding: 20px; border-radius: 12px; }
    .control-group { display: flex; flex-direction: column; gap: 5px; }
    .control-group label { font-weight: 600; color: #333; font-size: 0.85em; }
    .control-group select { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; min-width: 180px; }
    .dashboard-btn { padding: 10px 20px; background: linear-gradient(135deg, #00b4d8, #0077b6); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .metric-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 15px; }
    .metric-icon { font-size: 2em; }
    .metric-content h3 { font-size: 1.8em; color: #1e3a5f; margin: 0; }
    .metric-content p { color: #666; margin: 5px 0 0 0; font-size: 0.9em; }
    .dashboard-charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px; }
    .chart-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); min-height: 300px; }
    .chart-card h3 { color: #1e3a5f; margin: 0 0 20px 0; font-size: 1.1em; }
    .chart-card canvas { width: 100% !important; height: 250px !important; }
    .chart-card-highlight { grid-column: span 2; }
    .chart-card-highlight canvas { height: 300px !important; }
    .kpi-section { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .kpi-header h2 { color: #1e3a5f; margin: 0 0 20px 0; font-size: 1.2em; }
    .dashboard-kpi-table { width: 100%; border-collapse: collapse; }
    .dashboard-kpi-table th { background: linear-gradient(135deg, #1e3a5f 0%, #0a1929 100%); color: white; padding: 12px; text-align: left; font-size: 0.85em; }
    .dashboard-kpi-table td { padding: 12px; border-bottom: 1px solid #eee; }
    .kpi-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
    .kpi-badge-cumple { background: #d4edda; color: #155724; }
    .kpi-badge-no-cumple { background: #f8d7da; color: #721c24; }
    @media (max-width: 900px) { .chart-card-highlight { grid-column: span 1; } .dashboard-charts-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block header_actions %}
<a href="{% url 'reporte' %}" class="header-btn">
    <i class="fas fa-list"></i> Ver Reportes
</a>
<button class="header-btn" id="exportDashboardPdfBtn">
    <i class="fas fa-file-pdf"></i> PDF
</button>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <section class="dashboard-controls">
        <div class="control-group">
            <label for="dashboardFiltroFecha">Per√≠odo:</label>
            <select id="dashboardFiltroFecha">
                <option value="all" {% if filtros_aplicados.periodo == 'all' or not filtros_aplicados.periodo %}selected{% endif %}>Todo</option>
                <option value="week" {% if filtros_aplicados.periodo == 'week' %}selected{% endif %}>√öltima semana</option>
                <option value="month" {% if filtros_aplicados.periodo == 'month' %}selected{% endif %}>√öltimo mes</option>
                <option value="quarter" {% if filtros_aplicados.periodo == 'quarter' %}selected{% endif %}>√öltimos 3 meses</option>
            </select>
        </div>
        <div class="control-group">
            <label for="dashboardFiltroCentro">Centro:</label>
            <select id="dashboardFiltroCentro">
                <option value="">Todos</option>
                {% for c in centros %}<option value="{{ c.id }}" {% if filtros_aplicados.centro == c.id|stringformat:"s" %}selected{% endif %}>{{ c.nombre }}</option>{% endfor %}
            </select>
        </div>
        <button id="actualizarDashboard" class="dashboard-btn"><i class="fas fa-sync"></i> Actualizar</button>
    </section>
    
    <section class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">üìã</div>
            <div class="metric-content">
                <h3 id="totalIncidencias">{{ total_incidencias }}</h3>
                <p>Total Incidencias</p>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">üèÜ</div>
            <div class="metric-content">
                <h3 id="centroMasIncidencias">{{ centro_mas_incidencias }}</h3>
                <p>Centro con M√°s</p>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">‚è±Ô∏è</div>
            <div class="metric-content">
                <h3 id="tiempoPromedio">{{ promedio_resolucion }}</h3>
                <p>Tiempo Promedio (min)</p>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">‚ö†Ô∏è</div>
            <div class="metric-content">
                <h3 id="riesgoAlto">{{ alto_riesgo_count }}</h3>
                <p>Alto Riesgo</p>
            </div>
        </div>
    </section>
    
    <section class="dashboard-charts-grid">
        <div class="chart-card">
            <h3>üìç Incidencias por Centro</h3>
            <canvas id="chartIncidenciasCentro"></canvas>
        </div>
        <div class="chart-card">
            <h3>üìà Tendencia Temporal</h3>
            <canvas id="chartTendencia"></canvas>
        </div>
        <div class="chart-card">
            <h3>üîÑ M√≥dulos vs Sensores</h3>
            <canvas id="chartTipos"></canvas>
        </div>
        <div class="chart-card">
            <h3>üè∑Ô∏è Tipos Espec√≠ficos</h3>
            <canvas id="chartClasificacion"></canvas>
        </div>
        <div class="chart-card chart-card-highlight">
            <h3>üéØ Distribuci√≥n por Categor√≠a</h3>
            <canvas id="chartCategorias"></canvas>
        </div>
    </section>
    
    <section class="kpi-section">
        <div class="kpi-header">
            <h2>KPIs de Cumplimiento (Meta: 20 min / 80%)</h2>
        </div>
        <table class="dashboard-kpi-table">
            <thead>
                <tr>
                    <th>Centro</th>
                    <th>Total</th>
                    <th>En KPI (‚â§20 min)</th>
                    <th>% Cumplimiento</th>
                    <th>Meta (>80%)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in kpi_data %}
                <tr>
                    <td><strong>{{ item.centro_nombre }}</strong></td>
                    <td>{{ item.total_incidencias }}</td>
                    <td>{{ item.en_kpi }}</td>
                    <td><strong>{{ item.porcentaje }}%</strong></td>
                    <td>{% if item.cumple_meta %}<span class="kpi-badge kpi-badge-cumple">‚úì Cumple</span>{% else %}<span class="kpi-badge kpi-badge-no-cumple">‚úó No Cumple</span>{% endif %}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" style="text-align: center; color: #999; padding: 30px;">No hay datos de KPI.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    window.CHART_CENTRO_LABELS = {{ chart_centro_labels_json|safe }};
    window.CHART_CENTRO_DATA = {{ chart_centro_counts_json|safe }};
    window.CHART_TENDENCIA_LABELS = {{ chart_tendencia_labels_json|safe }};
    window.CHART_TENDENCIA_DATA = {{ chart_tendencia_data_json|safe }};
    window.CHART_TIPOS_DATA = {{ chart_tipos_data_json|safe }};
    window.CHART_OPERARIO_LABELS = {{ chart_operario_labels_json|safe }};
    window.CHART_OPERARIO_DATA = {{ chart_operario_data_json|safe }};
    window.CHART_CLASIFICACION_LABELS = {{ chart_clasificacion_labels_json|safe }};
    window.CHART_CLASIFICACION_DATA = {{ chart_clasificacion_data_json|safe }};
    window.CHART_CATEGORIAS_LABELS = {{ chart_categorias_labels_json|safe }};
    window.CHART_CATEGORIAS_DATA = {{ chart_categorias_data_json|safe }};
</script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
